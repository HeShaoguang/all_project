###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.10.3.10338/W32 for 8051         18/Apr/2021  22:45:50 #
# Copyright 2004-2011 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\Source\GuangAp #
#                          p485.c                                             #
#    Command line       =  -f C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1. #
#                          4.0\Projects\zstack\Samples\GenericApp\CC2530DB\.. #
#                          \..\..\Tools\CC2530DB\f8wCoord.cfg (-DCPU32MHZ     #
#                          -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                          E -DZDO_COORDINATOR -DRTR_NWK -DBLINK_LEDS) -f     #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\Tools\CC2530DB\f8wConfig.cfg (-DSECURE=0       #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0x1454                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116 "-DCONST=const __code"    #
#                          -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE     #
#                          -DPOLL_RATE=1000 -DQUEUED_POLL_RATE=100            #
#                          -DRESPONSE_POLL_RATE=100) -DREJOIN_POLL_RATE=440   #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\Source\GuangAp #
#                          p485.c -D ZTOOL_P1 -D MT_TASK -D MT_SYS_FUNC -D    #
#                          MT_ZDO_FUNC -D LCD_SUPPORTED=DEBUG -lC             #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\Coord #
#                          inatorEB\List\ -lA C:\zigbeetest\MyProject2\ZStack #
#                          -CC2530-2.3.0-1.4.0\Projects\zstack\Samples\Generi #
#                          cApp\CC2530DB\CoordinatorEB\List\ --diag_suppress  #
#                          Pe001,Pa010 -o C:\zigbeetest\MyProject2\ZStack-CC2 #
#                          530-2.3.0-1.4.0\Projects\zstack\Samples\GenericApp #
#                          \CC2530DB\CoordinatorEB\Obj\ -e --debug            #
#                          --core=plain --dptr=16,1 --data_model=large        #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 16 -I C:\zigbeetest\MyProject2\Z #
#                          Stack-CC2530-2.3.0-1.4.0\Projects\zstack\Samples\G #
#                          enericApp\CC2530DB\ -I C:\zigbeetest\MyProject2\ZS #
#                          tack-CC2530-2.3.0-1.4.0\Projects\zstack\Samples\Ge #
#                          nericApp\CC2530DB\..\SOURCE\ -I                    #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\ZMAIN\TI2530DB\ -I C:\zigbeetest\MyProject2\ZS #
#                          tack-CC2530-2.3.0-1.4.0\Projects\zstack\Samples\Ge #
#                          nericApp\CC2530DB\..\..\..\..\..\COMPONENTS\MT\    #
#                          -I C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1. #
#                          4.0\Projects\zstack\Samples\GenericApp\CC2530DB\.. #
#                          \..\..\..\..\COMPONENTS\HAL\INCLUDE\ -I            #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\HAL\TARGET\CC2530EB\ -I       #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\OSAL\MCU\CCSOC\ -I            #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\OSAL\INCLUDE\ -I              #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\STACK\AF\ -I                  #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\STACK\NWK\ -I                 #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\STACK\SEC\ -I                 #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\STACK\SAPI\ -I                #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\STACK\SYS\ -I                 #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\STACK\ZDO\ -I                 #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\ZMAC\F8W\ -I                  #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\ZMAC\ -I                      #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\SERVICES\SADDR\ -I            #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\SERVICES\SDATA\ -I            #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\MAC\INCLUDE\ -I               #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\MAC\HIGH_LEVEL\ -I            #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\MAC\LOW_LEVEL\srf04\ -I       #
#                          C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\..\.. #
#                          \..\..\..\COMPONENTS\MAC\LOW_LEVEL\srf04\SINGLE_CH #
#                          IP\ -Ohz --require_prototypes                      #
#    List file          =  C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\Coord #
#                          inatorEB\List\GuangApp485.lst                      #
#    Object file        =  C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0 #
#                          \Projects\zstack\Samples\GenericApp\CC2530DB\Coord #
#                          inatorEB\Obj\GuangApp485.r51                       #
#                                                                             #
#                                                                             #
###############################################################################

C:\zigbeetest\MyProject2\ZStack-CC2530-2.3.0-1.4.0\Projects\zstack\Samples\GenericApp\Source\GuangApp485.c
      1          /**************************************************************************************************
      2            Filename:       GuangApp.c
      3            Revised:        $Date: 2009-03-18 15:56:27 -0700 (Wed, 18 Mar 2009) $
      4            Revision:       $Revision: 19453 $
      5          
      6            Description:    Generic Application (no Profile).
      7          
      8          
      9            Copyright 2004-2009 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED AS IS?WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com. 
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41            This application isn't intended to do anything useful, it is
     42            intended to be a simple example of an application's structure.
     43          
     44            This application sends "Hello World" to another "Generic"
     45            application every 15 seconds.  The application will also
     46            receive "Hello World" packets.
     47          
     48            The "Hello World" messages are sent/received as MSG type message.
     49          
     50            This applications doesn't have a profile, so it handles everything
     51            directly - itself.
     52          
     53            Key control:
     54              SW1:
     55              SW2:  initiates end device binding
     56              SW3:
     57              SW4:  initiates a match description request
     58          *********************************************************************/
     59          
     60          /*********************************************************************
     61           * INCLUDES
     62           */
     63          #include <string.h>
     64          #include <stdio.h>
     65          #include "OSAL.h"
     66          #include "AF.h"
     67          #include "ZDApp.h"
     68          #include "ZDObject.h"
     69          #include "ZDProfile.h"
     70          
     71          #include "GuangApp.h"
     72          #include "DebugTrace.h"
     73          
     74          #if !defined( WIN32 )
     75            #include "OnBoard.h"
     76          #endif
     77          
     78          /* HAL */
     79          #include "hal_lcd.h"
     80          #include "hal_led.h"
     81          #include "hal_key.h"
     82          #include "hal_uart.h"
     83          #include "MT_UART.h"
     84          
     85          #include "DHT11.H"
     86          #include "THC485.h"
     87          /*********************************************************************
     88           * MACROS
     89           */
     90          
     91          /*********************************************************************
     92           * CONSTANTS
     93           */
     94          
     95          /*********************************************************************
     96           * TYPEDEFS
     97           */
     98          
     99          /*********************************************************************
    100           * GLOBAL VARIABLES
    101           */
    102          
    103          // This list should be filled with Application specific Cluster IDs.
    104          const cId_t GuangApp_ClusterList[GENERICAPP_MAX_CLUSTERS] =
    105          {
    106            GENERICAPP_CLUSTERID
    107          };
    108          
    109          const SimpleDescriptionFormat_t GuangApp_SimpleDesc =
    110          {
    111            GENERICAPP_ENDPOINT,              //  int Endpoint;
    112            GENERICAPP_PROFID,                //  uint16 AppProfId[2];
    113            GENERICAPP_DEVICEID,              //  uint16 AppDeviceId[2];
    114            GENERICAPP_DEVICE_VERSION,        //  int   AppDevVer:4;
    115            GENERICAPP_FLAGS,                 //  int   AppFlags:4;
    116            GENERICAPP_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    117            (cId_t *)GuangApp_ClusterList,  //  byte *pAppInClusterList;
    118            GENERICAPP_MAX_CLUSTERS,          //  byte  AppNumInClusters;
    119            (cId_t *)GuangApp_ClusterList   //  byte *pAppInClusterList;
    120          };
    121          
    122          // This is the Endpoint/Interface description.  It is defined here, but
    123          // filled-in in GuangApp_Init().  Another way to go would be to fill
    124          // in the structure here and make it a "const" (in code space).  The
    125          // way it's defined in this sample app it is define in RAM.
    126          endPointDesc_t GuangApp_epDesc;
    127          
    128          /*********************************************************************
    129           * EXTERNAL VARIABLES
    130           */
    131          
    132          /*********************************************************************
    133           * EXTERNAL FUNCTIONS
    134           */
    135          
    136          /*********************************************************************
    137           * LOCAL VARIABLES
    138           */
    139          byte GuangApp_TaskID;   // Task ID for internal task/event processing
    140                                    // This variable will be received when
    141                                    // GuangApp_Init() is called.
    142          devStates_t GuangApp_NwkState;
    143          
    144          
    145          byte GuangApp_TransID;  // This is the unique message ID (counter)
    146          
    147          afAddrType_t GuangApp_DstAddr;
    148          
    149          #define GUANG_APP_TX_MAX  50
    150          static uint8 GuangApp_TxBuf[GUANG_APP_TX_MAX+1];
    151          static uint8 GuangApp_TxLen;
    152          uint8 THCAsk[8]={0x01, 0x03, 0x00, 0x00, 0x00, 0x08, 0x44, 0x0c};
    153          uint16 THCnum = 0;
    154          uint8 THCstr[50];
    155            
    156          extern uint16 temperture;
    157          extern uint16 temperture_shi, temperture_ge, temperture_xiao;
    158          extern uint16 humidity485;
    159          extern uint16 humidity_shi, humidity_ge, humidity_xiao;
    160          extern uint16 CO2;
    161          extern uint16 CO2_qian, CO2_bai, CO2_shi, CO2_ge;
    162          /*********************************************************************
    163           * LOCAL FUNCTIONS
    164           */
    165          void GuangApp_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg );
    166          void GuangApp_HandleKeys( byte shift, byte keys );
    167          void GuangApp_MessageMSGCB( afIncomingMSGPacket_t *pckt );
    168          void GuangApp_SendTheMessage( void );
    169          extern uint16 GetCrcData(uint8 *buffer, uint16 len);
    170          /*********************************************************************
    171           * NETWORK LAYER CALLBACKS
    172           */
    173          
    174          /*********************************************************************
    175           * PUBLIC FUNCTIONS
    176           */
    177          
    178          /*********************************************************************
    179           * @fn      GuangApp_Init
    180           *
    181           * @brief   Initialization function for the Generic App Task.
    182           *          This is called during initialization and should contain
    183           *          any application specific initialization (ie. hardware
    184           *          initialization/setup, table initialization, power up
    185           *          notificaiton ... ).
    186           *
    187           * @param   task_id - the ID assigned by OSAL.  This ID should be
    188           *                    used to send messages and set timers.
    189           *
    190           * @return  none
    191           */
    192          void GuangApp_Init( byte task_id )
    193          {
    194            GuangApp_TaskID = task_id;
    195            GuangApp_NwkState = DEV_INIT;
    196            GuangApp_TransID = 0;
    197          
    198            //------------------------配置串口---------------------------------TXD----接p0_4  RXD--接P0_5
    199            MT_UartInit();                    //串口初始化   里面可以修改波特率
    200            MT_UartRegisterTaskID(task_id);   //注册串口任务
    201            HalUARTWrite(0,"\n strTemp\n", sizeof("\n strTemp\n"));//串口发送
    202            //-----------------------------------------------------------------
    203          
    204             //----------初始化IO口-------------------
    205            P0SEL &= 0x7f;
    206            //----------------------------------------
    207            
    208            GuangApp_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;
    209            GuangApp_DstAddr.endPoint = GENERICAPP_ENDPOINT;
    210            GuangApp_DstAddr.addr.shortAddr = 0x0000;
    211          
    212            // Fill out the endpoint description.
    213            GuangApp_epDesc.endPoint = GENERICAPP_ENDPOINT;
    214            GuangApp_epDesc.task_id = &GuangApp_TaskID;
    215            GuangApp_epDesc.simpleDesc
    216                      = (SimpleDescriptionFormat_t *)&GuangApp_SimpleDesc;
    217            GuangApp_epDesc.latencyReq = noLatencyReqs;
    218          
    219            // Register the endpoint description with the AF
    220            afRegister( &GuangApp_epDesc );
    221          
    222            // Register for all key events - This app will handle all key events
    223            RegisterForKeys( GuangApp_TaskID );
    224          
    225            // Update the display
    226          #if defined ( LCD_SUPPORTED )
    227              HalLcdWriteString( "GuangApp", HAL_LCD_LINE_1 );
    228          #endif
    229              
    230          //  ZDO_RegisterForZDOMsg( GuangApp_TaskID, End_Device_Bind_rsp );    ???
    231          //  ZDO_RegisterForZDOMsg( GuangApp_TaskID, Match_Desc_rsp );      ???
    232          }
    233          
    234          /*********************************************************************
    235           * @fn      GuangApp_ProcessEvent
    236           *
    237           * @brief   Generic Application Task event processor.  This function
    238           *          is called to process all events for the task.  Events
    239           *          include timers, messages and any other user defined events.
    240           *
    241           * @param   task_id  - The OSAL assigned task ID.
    242           * @param   events - events to process.  This is a bit map and can
    243           *                   contain more than one event.
    244           *
    245           * @return  none
    246           */
    247          UINT16 GuangApp_ProcessEvent( byte task_id, UINT16 events )
    248          {
    249            afIncomingMSGPacket_t *MSGpkt;
    250            afDataConfirm_t *afDataConfirm;
    251          
    252            // Data Confirmation message fields
    253            byte sentEP;
    254            ZStatus_t sentStatus;
    255            byte sentTransID;       // This should match the value sent
    256            (void)task_id;  // Intentionally unreferenced parameter
    257          
    258            if ( events & SYS_EVENT_MSG )
    259            {
    260              MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( GuangApp_TaskID );
    261              while ( MSGpkt )
    262              {
    263                switch ( MSGpkt->hdr.event )
    264                {
    265                  case ZDO_CB_MSG:
    266                    GuangApp_ProcessZDOMsgs( (zdoIncomingMsg_t *)MSGpkt );
    267                    break;
    268                    
    269                  case KEY_CHANGE:
    270                    GuangApp_HandleKeys( ((keyChange_t *)MSGpkt)->state, ((keyChange_t *)MSGpkt)->keys );
    271                    break;
    272          
    273                  case AF_DATA_CONFIRM_CMD:
    274                    // This message is received as a confirmation of a data packet sent.
    275                    // The status is of ZStatus_t type [defined in ZComDef.h]
    276                    // The message fields are defined in AF.h
    277                    afDataConfirm = (afDataConfirm_t *)MSGpkt;
    278                    sentEP = afDataConfirm->endpoint;
    279                    sentStatus = afDataConfirm->hdr.status;
    280                    sentTransID = afDataConfirm->transID;
    281                    (void)sentEP;
    282                    (void)sentTransID;
    283          
    284                    // Action taken when confirmation is received.
    285                    if ( sentStatus != ZSuccess )
    286                    {
    287                      // The data wasn't delivered -- Do something
    288                    }
    289                    break;
    290          
    291                  case AF_INCOMING_MSG_CMD:
    292                    GuangApp_MessageMSGCB( MSGpkt );
    293                    break;
    294          
    295                  case ZDO_STATE_CHANGE:
    296                    GuangApp_NwkState = (devStates_t)(MSGpkt->hdr.status);
    297                    if ( //(GuangApp_NwkState == DEV_ZB_COORD)
    298                        //|| (GuangApp_NwkState == DEV_ROUTER)
    299                        //|| 
    300                          (GuangApp_NwkState == DEV_END_DEVICE) )
    301                    {
    302                      // Start sending "the" message in a regular interval.
    303                      osal_start_timerEx( GuangApp_TaskID,
    304                                          GENERICAPP_SEND_MSG_EVT,
    305                                        GENERICAPP_SEND_MSG_TIMEOUT );
    306                    }
    307                    break;
    308          
    309                  default:
    310                    break;
    311                }
    312          
    313                // Release the memory
    314                osal_msg_deallocate( (uint8 *)MSGpkt );
    315          
    316                // Next
    317                MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( GuangApp_TaskID );
    318              }
    319          
    320              // return unprocessed events
    321              return (events ^ SYS_EVENT_MSG);
    322            }
    323          
    324            // Send a message out - This event is generated by a timer
    325            //  (setup in GuangApp_Init()).
    326            if ( events & GENERICAPP_SEND_MSG_EVT )
    327            {
    328              // Send "the" message
    329              GuangApp_SendTheMessage();
    330          
    331              // Setup to send message again
    332              osal_start_timerEx( GuangApp_TaskID,
    333                                  GENERICAPP_SEND_MSG_EVT,
    334                                GENERICAPP_SEND_MSG_TIMEOUT );
    335          
    336              // return unprocessed events
    337              return (events ^ GENERICAPP_SEND_MSG_EVT);
    338            }
    339          
    340            // Discard unknown events
    341            return 0;
    342          }
    343          
    344          /*********************************************************************
    345           * Event Generation Functions
    346           */
    347          
    348          /*********************************************************************
    349           * @fn      GuangApp_ProcessZDOMsgs()
    350           *
    351           * @brief   Process response messages
    352           *
    353           * @param   none
    354           *
    355           * @return  none
    356           */
    357          void GuangApp_ProcessZDOMsgs( zdoIncomingMsg_t *inMsg )
    358          {
    359            switch ( inMsg->clusterID )
    360            {
    361              case End_Device_Bind_rsp:
    362                if ( ZDO_ParseBindRsp( inMsg ) == ZSuccess )
    363                {
    364                  // Light LED
    365                  HalLedSet( HAL_LED_4, HAL_LED_MODE_ON );
    366                }
    367          #if defined(BLINK_LEDS)
    368                else
    369                {
    370                  // Flash LED to show failure
    371                  HalLedSet ( HAL_LED_4, HAL_LED_MODE_FLASH );
    372                }
    373          #endif
    374                break;
    375          
    376              case Match_Desc_rsp:
    377                {
    378                  ZDO_ActiveEndpointRsp_t *pRsp = ZDO_ParseEPListRsp( inMsg );
    379                  if ( pRsp )
    380                  {
    381                    if ( pRsp->status == ZSuccess && pRsp->cnt )
    382                    {
    383                      GuangApp_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;
    384                      GuangApp_DstAddr.addr.shortAddr = pRsp->nwkAddr;
    385                      // Take the first endpoint, Can be changed to search through endpoints
    386                      GuangApp_DstAddr.endPoint = pRsp->epList[0];
    387          
    388                      // Light LED
    389                      HalLedSet( HAL_LED_4, HAL_LED_MODE_ON );
    390                    }
    391                    osal_mem_free( pRsp );
    392                  }
    393                }
    394                break;
    395            }
    396          }
    397          
    398          /*********************************************************************
    399           * @fn      GuangApp_HandleKeys
    400           *
    401           * @brief   Handles all key events for this device.
    402           *
    403           * @param   shift - true if in shift/alt.
    404           * @param   keys - bit field for key events. Valid entries:
    405           *                 HAL_KEY_SW_4
    406           *                 HAL_KEY_SW_3
    407           *                 HAL_KEY_SW_2
    408           *                 HAL_KEY_SW_1
    409           *
    410           * @return  none
    411           */
    412          void GuangApp_HandleKeys( byte shift, byte keys )
    413          {
    414            zAddrType_t dstAddr;
                               ^
Warning[Pe177]: variable "dstAddr" was declared but never referenced
    415            
    416            // Shift is used to make each button/switch dual purpose.
    417            if ( shift )
    418            {
    419              if ( keys & HAL_KEY_SW_1 )
    420              {
    421              }
    422              if ( keys & HAL_KEY_SW_2 )
    423              {
    424              }
    425              if ( keys & HAL_KEY_SW_3 )
    426              {
    427              }
    428              if ( keys & HAL_KEY_SW_4 )
    429              {
    430              }
    431            }
    432            else
    433            {
    434              if ( keys & HAL_KEY_SW_1 )
    435              {
    436              }
    437          
    438              if ( keys & HAL_KEY_SW_2 )
    439              {
    440          //      HalLedSet ( HAL_LED_4, HAL_LED_MODE_OFF );
    441          //
    442          //      // Initiate an End Device Bind Request for the mandatory endpoint
    443          //      dstAddr.addrMode = Addr16Bit;
    444          //      dstAddr.addr.shortAddr = 0x0000; // Coordinator
    445          //      ZDP_EndDeviceBindReq( &dstAddr, NLME_GetShortAddr(), 
    446          //                            GuangApp_epDesc.endPoint,
    447          //                            GENERICAPP_PROFID,
    448          //                            GENERICAPP_MAX_CLUSTERS, (cId_t *)GuangApp_ClusterList,
    449          //                            GENERICAPP_MAX_CLUSTERS, (cId_t *)GuangApp_ClusterList,
    450          //                            FALSE );
    451              }
    452          
    453              if ( keys & HAL_KEY_SW_3 )
    454              {
    455              }
    456          
    457              if ( keys & HAL_KEY_SW_4 )
    458              {
    459          //      HalLedSet ( HAL_LED_4, HAL_LED_MODE_OFF );
    460          //      // Initiate a Match Description Request (Service Discovery)
    461          //      dstAddr.addrMode = AddrBroadcast;
    462          //      dstAddr.addr.shortAddr = NWK_BROADCAST_SHORTADDR;
    463          //      ZDP_MatchDescReq( &dstAddr, NWK_BROADCAST_SHORTADDR,
    464          //                        GENERICAPP_PROFID,
    465          //                        GENERICAPP_MAX_CLUSTERS, (cId_t *)GuangApp_ClusterList,
    466          //                        GENERICAPP_MAX_CLUSTERS, (cId_t *)GuangApp_ClusterList,
    467          //                        FALSE );
    468              }
    469            }
    470          }
    471          
    472          /*********************************************************************
    473           * LOCAL FUNCTIONS
    474           */
    475          
    476          /*********************************************************************
    477           * @fn      GuangApp_MessageMSGCB
    478           *
    479           * @brief   Data message processor callback.  This function processes
    480           *          any incoming data - probably from other devices.  So, based
    481           *          on cluster ID, perform the intended action.
    482           *
    483           * @param   none
    484           *
    485           * @return  none
    486           */
    487          void GuangApp_MessageMSGCB( afIncomingMSGPacket_t *pkt )
    488          {
    489            switch ( pkt->clusterId )
    490            {
    491              case GENERICAPP_CLUSTERID:
    492                // "the" message
    493              //------------添加打印--------------
    494                HalUARTWrite(0, "Rx:", 3); //提示信息 
    495                HalUARTWrite(0, pkt->cmd.Data, pkt->cmd.DataLength); //输出接收到的数据 
    496                HalUARTWrite(0, "\n", 1); //回车换行 
    497               //------------------------------------
    498          //#if defined( LCD_SUPPORTED )
    499          //      HalLcdWriteScreen( (char*)pkt->cmd.Data, "rcvd" );
    500          //#elif defined( WIN32 )
    501          //      WPRINTSTR( pkt->cmd.Data );
    502          //#endif
    503                break;
    504            }
    505          }
    506          
    507          /*********************************************************************
    508           * @fn      GuangApp_SendTheMessage
    509           *
    510           * @brief   Send "the" message.
    511           *
    512           * @param   none
    513           *
    514           * @return  none
    515           */
    516          void GuangApp_SendTheMessage( void )
    517          {
    518                HalUARTWrite(1, THCAsk, 8);
    519          }
    520          
    521          
    522          extern void rxCB(uint8 port,uint8 event)
                             ^
Error[Pa045]: function "rxCB" has no prototype
    523          {
    524          
    525            if (GuangApp_TxLen < GUANG_APP_TX_MAX)
    526                  {
    527                      GuangApp_TxLen = HalUARTRead(port, GuangApp_TxBuf, GUANG_APP_TX_MAX);
    528                      if (GuangApp_TxLen)
    529                      {
    530                      //双串口互错传输
    531                      //串口0发---> 串口1收
    532                      //串口1发---> 串口0收
    533          
    534                          if(port==1)
    535                          {
    536                              //HalUARTWrite(0, GuangApp_TxBuf, GuangApp_TxLen);
    537                            if(GuangApp_TxBuf[0] == 0x01){//isCRC(GuangApp_TxBuf,20) == 't' && GuangApp_TxBuf[0] == 0x01){
    538                              HalLedSet(HAL_LED_4,HAL_LED_MODE_TOGGLE);
    539                               THCnum = 0;
    540                               memset(THCstr,0,50);
    541                               THCstr[THCnum++] = '{';
    542                               THCstr[THCnum++] = 'i';
    543                               THCstr[THCnum++] = 'd';
    544                               THCstr[THCnum++] = ':';
    545                               THCstr[THCnum++] = '0';
    546                               THCstr[THCnum++] = '1';
    547                               THCstr[THCnum++] = ',';
    548                               THCstr[THCnum++] = 't';
    549                               THCstr[THCnum++] = 'y';
    550                               THCstr[THCnum++] = 'p';
    551                               THCstr[THCnum++] = 'e';
    552                               THCstr[THCnum++] = ':';
    553                               THCstr[THCnum++] = '4';
    554                               THCstr[THCnum++] = '8';
    555                               THCstr[THCnum++] = '5';
    556                               THCstr[THCnum++] = ',';
    557                               
    558                               humidity485 = ((GuangApp_TxBuf[3]) << 8 | GuangApp_TxBuf[4]);
    559                               if(humidity485 <1000 && humidity485>0){
    560                                  humidity_shi = humidity485/100;
    561                                  humidity_ge = (humidity485%100)/10;
    562                                  humidity_xiao = humidity485%10;
    563                                  
    564                                   THCstr[THCnum++] = 'h';
    565                                   THCstr[THCnum++] = 'u';
    566                                   THCstr[THCnum++] = 'm';
    567                                   THCstr[THCnum++] = ':';
    568                                   THCstr[THCnum++] = humidity_shi+0x30;
    569                                   THCstr[THCnum++] = humidity_ge+0x30;
    570                                   THCstr[THCnum++] = '.';
    571                                   THCstr[THCnum++] = humidity_xiao+0x30;
    572                                   THCstr[THCnum++] = ',';
    573                                }
    574                               
    575                               temperture = ((GuangApp_TxBuf[5]) << 8 | GuangApp_TxBuf[6]);
    576                               if(temperture <1000 && temperture>0){
    577                                  temperture_shi = temperture/100;
    578                                  temperture_ge = (temperture%100)/10;
    579                                  temperture_xiao = temperture%10;
    580                                   THCstr[THCnum++] = 't';
    581                                   THCstr[THCnum++] = 'e';
    582                                   THCstr[THCnum++] = 'm';
    583                                   THCstr[THCnum++] = ':';
    584                                   THCstr[THCnum++] = temperture_shi+0x30;
    585                                   THCstr[THCnum++] = temperture_ge+0x30;
    586                                   THCstr[THCnum++] = '.';
    587                                   THCstr[THCnum++] = temperture_xiao+0x30;
    588                                   THCstr[THCnum++] = ',';
    589                                }
    590                             
    591                             CO2 = ((GuangApp_TxBuf[17]) << 8 | GuangApp_TxBuf[18]);  
    592                               if(CO2 <10000 && CO2>0){
    593                                  CO2_qian = CO2/1000;
    594                                  CO2_bai = (CO2%1000)/100;
    595                                  CO2_shi = (CO2%100)/10;
    596                                  CO2_ge = CO2%10;
    597                                  THCstr[THCnum++] = 'c';
    598                                   THCstr[THCnum++] = 'o';
    599                                   THCstr[THCnum++] = '2';
    600                                   THCstr[THCnum++] = ':';
    601                                   THCstr[THCnum++] = CO2_qian+0x30;
    602                                   THCstr[THCnum++] = CO2_bai+0x30;
    603                                   THCstr[THCnum++] = CO2_shi+0x30;
    604                                   THCstr[THCnum++] = CO2_ge+0x30;
    605                                   THCstr[THCnum++] = ',';
    606                                } 
    607                               THCstr[THCnum++] = '}';
    608                               HalUARTWrite(0,THCstr, THCnum);
    609                               AF_DataRequest( &GuangApp_DstAddr, &GuangApp_epDesc,
    610                                 GENERICAPP_CLUSTERID,
    611                                 THCnum,
    612                                 THCstr,
    613                                 &GuangApp_TransID,
    614                                 AF_DISCV_ROUTE, AF_DEFAULT_RADIUS );
    615                             }
    616                            THCnum = 0;
    617                          }
    618                          else
    619                          {
    620                              HalUARTWrite(1, GuangApp_TxBuf, GuangApp_TxLen);
    621                          }
    622          
    623                       }            
    624          
    625                      GuangApp_TxLen = 0;
    626                  }
    627          }
    628          /*********************************************************************
    629          *********************************************************************/

Errors: 1
Warnings: 1
